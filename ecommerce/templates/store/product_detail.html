{% extends 'base.html' %}
{% load static %}
{% block content %}

<section class="section-content padding-y bg">
  <div class="container">
    {% include 'includes/alerts.html' %}

    <div class="card">
      <div class="row no-gutters">
        <aside class="col-md-6">
          <article class="gallery-wrap">
            <div class="img-big-wrap mainImage text-center">
              <img src="{{ single_product.images.url }}" alt="{{ single_product.product_name }}" loading="lazy" class="img-fluid main-photo">
            </div>

            <div class="thumb d-flex gap-2 mt-2">
              <a href="{{ single_product.images.url }}" data-large><img src="{{ single_product.images.url }}" alt="Thumbnail" loading="lazy" class="thumb-img"></a>
              {% for i in product_gallery %}
              <a href="{{ i.image.url }}" data-large><img src="{{ i.image.url }}" alt="Product Image" loading="lazy" class="thumb-img"></a>
              {% endfor %}
            </div>
          </article>
        </aside>

        <main class="col-md-6 border-left">
          <form action="{% url 'carts:add_cart' single_product.id %}" method="POST">
            {% csrf_token %}
            <article class="content-body">
              <h2 class="title">{{ single_product.product_name }}</h2>

              <div class="d-flex align-items-center mb-2">
                <div class="rating-star me-3" aria-hidden="true">
                  {% comment %} compact star rendering using averageReview {% endcomment %}
                  {% for i in "12345" %}
                    {% with idx=forloop.counter %}
                      {% if single_product.averageReview >= idx %}
                        <i class="fa fa-star" aria-hidden="true"></i>
                      {% elif single_product.averageReview >= idx|add:"-0.5" %}
                        <i class="fa fa-star-half-o" aria-hidden="true"></i>
                      {% else %}
                        <i class="fa fa-star-o" aria-hidden="true"></i>
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </div>
                <div>
                <span id="reviewCount" class="small text-muted">{{ total_reviews }} reviews</span>
                <span class="small text-muted ms-2">{{ percent_verified }}% verified buyers</span>
              </div>
              </div>

              <div class="mb-3">
                <var class="price h4">${{ single_product.price }}</var>
              </div>

              <p>{{ single_product.description|linebreaksbr }}</p>
              <hr>

              {% if colors %}
              <div class="mb-2">
                <label for="select-color" class="form-label">Choose Color</label>
                <select id="select-color" name="color" class="form-control" required>
                  <option value="" disabled selected>Select</option>
                  {% for color in colors %}
                    <option value="{{ color.variation_value|lower }}">{{ color.variation_value|capfirst }}</option>
                  {% endfor %}
                </select>
              </div>
              {% endif %}

              {% if sizes %}
              <div class="mb-2">
                <label for="select-size" class="form-label">Select Size</label>
                <select id="select-size" name="size" class="form-control" required>
                  <option value="" disabled selected>Select</option>
                  {% for size in sizes %}
                    <option value="{{ size.variation_value|lower }}">{{ size.variation_value|capfirst }}</option>
                  {% endfor %}
                </select>
              </div>
              {% endif %}

              <hr>
              {% if single_product.stock <= 0 %}
                <h5 class="text-danger">Out of Stock</h5>
              {% else %}
                <button type="submit" class="btn btn-primary" id="add-to-cart-btn" data-product-id="{{ single_product.id }}">
                  <span class="text">Add to Cart</span> <i class="fa fa-shopping-cart"></i>
                </button>
              {% endif %}
            </article>
          </form>
        </main>
      </div>
    </div>

    <br>

    <div class="row">
      <div class="col-md-9">

        {# ---------------- Review Form ---------------- #}
        <div class="card p-3 mb-3">
          <h5 class="mb-2">Write Your Review</h5>

          {% if not user.is_authenticated %}
            <p>You must be <a href="{% url 'accounts:login' %}">logged in</a> to post a review.</p>
          {% else %}
            {% if not has_purchased %}
              <p class="text-muted">Only verified purchasers can submit reviews. <a href="{% url 'carts:cart' %}">View your cart</a> or <a href="{% url 'accounts:dashboard' %}">view orders</a></p>
            {% endif %}
          {% endif %}

        <form id="review-form" action="{% url 'submit_review' single_product.id %}" method="POST" enctype="multipart/form-data" novalidate>
            {% csrf_token %}
            <fieldset id="rating-fieldset" aria-label="Rating" class="mb-2">
              <legend class="small">How do you rate this product?</legend>

              <div class="rate" role="radiogroup" aria-labelledby="rating-fieldset">
                {# Radio inputs placed visually as stars, keyboard accessible #}
              {% for v in "54321" %}
                <input type="radio" id="rating{{ v }}" name="rating" value="{{ v }}" class="visually-hidden" aria-label="{{ v }} stars"
                   {% if existing_review and existing_review.rating|stringformat:"i" == v %}checked{% endif %}
                   {% if not existing_review and forloop.first %}required{% endif %} required>
                <label for="rating{{ v }}" class="star" data-value="{{ v }}" tabindex="0" role="radio" aria-checked="false">
                  <i class="fa fa-star" aria-hidden="true"></i>
                </label>
              {% endfor %}
              </div>
            </fieldset>

            <div class="mb-2">
              <label for="review-subject" class="form-label">Review Title</label>
              <input id="review-subject" name="subject" type="text" class="form-control" maxlength="100" placeholder="Summarize your experience (optional)"
                     value="{{ existing_review.subject|default_if_none:'' }}">
            </div>

            <div class="mb-2">
              <label for="review-text" class="form-label">Review</label>
              <textarea id="review-text" name="review" class="form-control" rows="4" maxlength="2000" placeholder="Write your review here" required>{{ existing_review.review|default_if_none:'' }}</textarea>
              <div id="charcount" class="form-text text-muted">0 / 2000</div>
              <div id="review-text-error" class="invalid-feedback"></div>
            </div>

            <div class="mb-2">
              <label for="review-image" class="form-label">Upload Photo (optional)</label>
              <input id="review-image" name="image" type="file" class="form-control" accept="image/*">
              <small class="form-text text-muted">Max 5MB, JPEG/PNG/GIF/WebP only</small>
              <div id="review-image-error" class="invalid-feedback"></div>
            </div>

            {# Disable submit if not authenticated or not a purchaser #}
            <div class="d-flex gap-2 align-items-center">
              {% if user.is_authenticated and has_purchased %}
                <button id="submit-review-btn" type="submit" class="btn btn-primary">
                  {% if existing_review %}Update Review{% else %}Submit Review{% endif %}
                </button>
              {% elif user.is_authenticated and not has_purchased %}
                <button class="btn btn-secondary" disabled title="Purchase required">Submit Review</button>
              {% else %}
                <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn-primary">Login to Review</a>
              {% endif %}
              <div id="review-feedback" class="ms-3" aria-live="polite"></div>
            </div>
            {% if existing_review and existing_review.status == 'pending' %}
            <div class="alert alert-warning mt-2" role="alert">
              Your review is pending approval by the site moderators.
            </div>
            {% endif %}

            <div class="alert alert-info mt-2" role="status">
              Reviews are moderated; inappropriate content may be hidden.
            </div>
          </form>
        </div>

        {# ---------------- Reviews list ---------------- #}
        <header class="section-heading mb-3 d-flex justify-content-between align-items-center">
          <h3>Customer Reviews</h3>
          <div>
            <label for="review-sort" class="form-label small me-2">Sort by:</label>
            <select id="review-sort" class="form-select form-select-sm d-inline-block w-auto" aria-label="Sort reviews" onchange="location = this.value;">
              <option value="?sort=newest"{% if sort == 'newest' %} selected{% endif %}>Newest</option>
              <option value="?sort=highest"{% if sort == 'highest' %} selected{% endif %}>Highest rating</option>
              <option value="?sort=lowest"{% if sort == 'lowest' %} selected{% endif %}>Lowest rating</option>
              <option value="?sort=most_helpful"{% if sort == 'most_helpful' %} selected{% endif %}>Most helpful</option>
            </select>
          </div>
        </header>

        <div id="reviews-list" aria-live="polite">
          {% for review in reviews %}
          <article class="box mb-3" id="review-{{ review.id }}">
            <div class="d-flex justify-content-between">
              <div>
                <h6 class="mb-1">{{ review.user.full_name }}</h6>
                <small class="text-muted">
                  {% if review.is_verified_purchase %} <span class="badge bg-success">Verified buyer</span>{% endif %}
                  &nbsp;• {{ review.updated_at|date:"M d, Y" }}
                </small>
              </div>
              <div class="text-end">
                <div class="rating-star">
                  {% for i in "12345" %}
                    {% with idx=forloop.counter %}
                      {% if review.rating >= idx %}
                        <i class="fa fa-star"></i>
                      {% else %}
                        <i class="fa fa-star-o"></i>
                      {% endif %}
                    {% endwith %}
                  {% endfor %}
                </div>
                <small class="text-muted">{{ review.helpful_votes }} found this helpful</small>
              </div>
            </div>

            <div class="mt-3">
              {% if review.subject %}
                <h6>{{ review.subject }}</h6>
              {% endif %}
              <p>{{ review.review|linebreaksbr }}</p>
            </div>
          </article>
          {% empty %}
            <p class="text-muted">No reviews yet. Be the first to review this product.</p>
          {% endfor %}
        </div>

        {# Pagination controls #}
        <nav aria-label="Reviews pagination" class="mt-3">
          <ul class="pagination justify-content-center">
            {% if reviews.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ reviews.previous_page_number }}{% if sort %}&sort={{ sort }}{% endif %}" aria-label="Previous">
                <span aria-hidden="true">&laquo; Previous</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo; Previous</span>
            </li>
            {% endif %}

            <li class="page-item disabled">
              <span class="page-link">Page {{ reviews.number }} of {{ reviews.paginator.num_pages }}</span>
            </li>

            {% if reviews.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ reviews.next_page_number }}{% if sort %}&sort={{ sort }}{% endif %}" aria-label="Next">
                <span aria-hidden="true">Next &raquo;</span>
              </a>
            </li>
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">Next &raquo;</span>
            </li>
            {% endif %}
          </ul>
        </nav>

      </div>
    </div>
  </div>
</section>

{# ---------------- Set JS variables ---------------- #}
<script>
  const isAuthenticated = "{{ user.is_authenticated }}" === "True";
  const hasPurchased = "{{ has_purchased }}" === "True";
</script>

{# ---------------- Inline JS for stars, preview, optimistic append ---------------- #}
<script>
(function(){
  // star widget: keyboard + click handling
  const starLabels = document.querySelectorAll('.rate .star, .rate label, .star');
  const radios = document.querySelectorAll('#review-form input[type="radio"][name="rating"]');
  function setStars(val){
    radios.forEach(r => r.checked = (r.value === String(val)));
    document.querySelectorAll('.star').forEach(lbl => {
      lbl.classList.toggle('active', Number(lbl.dataset.value) <= Number(val));
      lbl.setAttribute('aria-checked', Number(lbl.dataset.value) === Number(val));
    });
  }
  document.querySelectorAll('.star').forEach(lbl=>{
    lbl.addEventListener('click', ()=> setStars(lbl.dataset.value));
    lbl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){ e.preventDefault(); setStars(lbl.dataset.value); }
      if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ e.preventDefault(); let v = Math.max(1, Number(lbl.dataset.value)-1); setStars(v); }
      if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ e.preventDefault(); let v = Math.min(5, Number(lbl.dataset.value)+1); setStars(v); }
    });
  });

  // char counter
  const textarea = document.getElementById('review-text');
  const charcount = document.getElementById('charcount');
  if(textarea){
    textarea.addEventListener('input', ()=> {
      charcount.textContent = textarea.value.length + ' / 2000';
    });
  }

  // optimistic submit: intercept POST, append preview, then submit normally.
  const form = document.getElementById('review-form');
  const reviewsList = document.getElementById('reviews-list');
  const feedback = document.getElementById('review-feedback');
  if(form && reviewsList){
    form.addEventListener('submit', async (e)=>{
      // check purchaser and auth state server-side too — this is just UX
      if (!isAuthenticated || !hasPurchased) {
        e.preventDefault();
        feedback.innerHTML = '<span class="text-danger">You must be logged in and have purchased this product to submit a review.</span>';
        return;
      }

      e.preventDefault();

      // Clear previous errors
      feedback.textContent = '';
      document.getElementById('review-text-error').textContent = '';
      document.getElementById('review-image-error').textContent = '';

      const formData = new FormData(form);
      const payload = {};
      for (const [k,v] of formData.entries()){ payload[k]=v; }

      // Frontend validations
      let valid = true;

      if(!payload.rating){
        feedback.innerHTML = '<span class="text-danger">Please select a rating.</span>';
        valid = false;
      }
      if(!payload.review || payload.review.trim().length < 10){
        document.getElementById('review-text-error').textContent = 'Review text must be at least 10 characters.';
        valid = false;
      }

      const imageInput = document.getElementById('review-image');
      if(imageInput.files.length > 0){
        const file = imageInput.files[0];
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        if(!allowedTypes.includes(file.type)){
          document.getElementById('review-image-error').textContent = 'Only JPEG, PNG, GIF, and WebP formats are allowed.';
          valid = false;
        }
        if(file.size > maxSize){
          document.getElementById('review-image-error').textContent = 'Image size must be 5MB or less.';
          valid = false;
        }
      }

      if(!valid){
        return;
      }

      if(!payload.rating || !payload.review){ feedback.textContent = 'Please provide rating and review text.'; return; }

      // optimistic preview
      const now = new Date().toISOString();
      const previewId = 'preview-' + Date.now();
      const previewHTML = `
        <article class="box mb-3" id="${previewId}">
          <div class="d-flex justify-content-between">
            <div><h6 class="mb-1">{{ user.get_full_name|default:user.username }}</h6><small class="text-muted">Just now • Verified buyer</small></div>
            <div class="text-end"><div class="rating-star">${'★'.repeat(payload.rating)}${'☆'.repeat(5-payload.rating)}</div></div>
          </div>
          <div class="mt-3"><h6>${(payload.subject || '').replace(/</g,'&lt;')}</h6><p>${(payload.review || '').replace(/</g,'&lt;')}</p></div>
        </article>`;
      reviewsList.insertAdjacentHTML('afterbegin', previewHTML);
      feedback.innerHTML = '<span class="text-success">Posting review…</span>';

      // send via fetch to same URL as form action
      try {
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value, 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest'},
          body: formData,
          credentials: 'include'
        });
        if(!resp.ok) throw resp;
        const data = await resp.json();
        if(data.success){
          feedback.innerHTML = '<span class="text-success">Review posted — confirmation email sent.</span>';
          // update preview element id to real id
          document.getElementById(previewId).id = 'review-' + data.review_id;
          // update review count
          const currentCount = parseInt(reviewCount.textContent.split(' ')[0]) || 0;
          reviewCount.textContent = (currentCount + 1) + ' reviews';
          // clear form
          form.reset();
          setStars(0); // reset stars
          charcount.textContent = '0 / 2000';
        } else {
          throw new Error(data.message || 'Submission failed');
        }
      } catch(err){
        feedback.innerHTML = '<span class="text-danger">Failed to post review. Please try again.</span>';
        // remove optimistic preview
        const node = document.getElementById(previewId);
        if(node) node.remove();
      }
    });
  }

  // simple thumbnail click to swap main image
  document.querySelectorAll('[data-large]').forEach(a=>{
    a.addEventListener('click', e=>{
      e.preventDefault();
      const url = a.getAttribute('href');
      const img = document.querySelector('.main-photo');
      if(img) img.src = url;
    });
  });

})();
</script>

<style>
/* small style overrides for stars and layout */
.rate .star, .star { cursor: pointer; font-size: 1.3rem; color: #ddd; display:inline-block; padding:0 .12rem; }
.star.active i, .rate .star:hover i, .rate .star:focus i { color: #f5b301; }
.thumb-img { width:56px; height:56px; object-fit:cover; border-radius:6px; border:1px solid #eee; }
.main-photo { max-width:100%; height:auto; }
.visually-hidden { position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
</style>

{% endblock %}
